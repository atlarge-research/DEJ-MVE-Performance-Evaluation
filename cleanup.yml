- name: clean up server side
  hosts: server
  gather_facts: false
  tasks:
    - name: Set end time
      shell: date -u +%Y-%m-%dT%H:%M:%S
      register: date
    - set_fact:
        end_time: "{{ date.stdout }}"
    - name: extract statistics from prometheus
      shell: "cd {{minecraft_tmp_dir.path}} && python extractStatistics.py {{start_time}} {{end_time}}"
      register: python_output 
    - name: fetch extracted statistics
      fetch:
        dest: "{{playbook_dir}}/metrics.json"
        src: "{{minecraft_tmp_dir.path}}/metrics.json"
      register: metrics_json_path
    - name: "move metrics"
      copy:
        src: "{{metrics_json_path.dest}}"
        dest: "{{playbook_dir}}/results/"
    - name: remove fetch folder
      file: 
        path: "{{playbook_dir}}/metrics.json/"
        state: absent
    - name: fetch server log(s)
      fetch:
        dest: "{{playbook_dir}}/logs"
        src: "{{minecraft_tmp_dir.path}}/logs/latest.log"
      register: logs_path
    - name: move logs
      copy:
        src: "{{logs_path.dest}}"
        dest: "{{playbook_dir}}/results/"
    - name: remove fetch folder
      file:
        path: "{{playbook_dir}}/logs"
        state: absent
    - name: Server side debug print
      debug:
        var: hostvars[inventory_hostname]
    - name: pause to allow inspection
      pause:
        seconds: 100
    - name: Kill java
      command: "killall java"
      ignore_errors: true
    - name: Kill prometheus
      command: "killall prometheus"   

- name: Clean up from experiment
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Cancel reservation
      shell: |
        module load prun
        preserve -c {{ reservation_number}}